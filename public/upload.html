<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload a Photo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        margin: 0;
        padding: 24px;
      }
      .card {
        max-width: 520px;
        margin: 0 auto;
        padding: 24px;
        border: 1px solid #ddd;
        border-radius: 12px;
      }
      h1 {
        margin: 0 0 8px;
      }
      p {
        margin: 0 0 16px;
        color: #444;
      }
      #drop {
        border: 2px dashed #bbb;
        border-radius: 12px;
        padding: 28px;
        text-align: center;
      }
      #drop.drag {
        border-color: #333;
      }
      #status {
        margin-top: 16px;
        font-size: 14px;
      }
      #preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
        gap: 8px;
        margin-top: 12px;
      }
      #preview img {
        width: 100%;
        height: 96px;
        object-fit: cover;
        border-radius: 8px;
      }
      button {
        padding: 10px 16px;
        border-radius: 8px;
        border: 1px solid #222;
        background: #111;
        color: #fff;
        cursor: pointer;
      }
      input[type="file"] {
        display: none;
      } /* hidden inputs triggered by buttons */
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: center;
        margin-top: 12px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Upload a Photo</h1>
      <p>Choose or drop images. They’ll show up on the TV in a moment.</p>

      <div id="drop">
        <div class="row">
          <button id="selectBtn" type="button">Select photos</button>
          <button id="cameraBtn" type="button">Open camera</button>
          <button id="uploadBtn" type="button">Upload</button>
        </div>

        <!-- hidden inputs -->
        <input id="file" type="file" accept="image/*" multiple />
        <input
          id="cameraInput"
          type="file"
          accept="image/*"
          capture="environment"
        />

        <div id="preview"></div>
      </div>

      <div id="status"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
      import {
        initializeApp,
        getApps,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
      import {
        getStorage,
        ref,
        uploadBytes,
      } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

      // ✅ Your Firebase config (kept firebasestorage.app as you prefer)
      const firebaseConfig = {
        apiKey: "AIzaSyDq_DTfqCiS0yUtThW550GOR3Hjpbhzhws",
        authDomain: "esp-project-1621c.firebaseapp.com",
        projectId: "esp-project-1621c",
        storageBucket: "esp-project-1621c.firebasestorage.app",
      };

      const app = getApps().length
        ? getApps()[0]
        : initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const storage = getStorage(app);

      // DOM
      const fileInput = document.getElementById("file");
      const cameraInput = document.getElementById("cameraInput");
      const selectBtn = document.getElementById("selectBtn");
      const cameraBtn = document.getElementById("cameraBtn");
      const uploadBtn = document.getElementById("uploadBtn");
      const statusEl = document.getElementById("status");
      const drop = document.getElementById("drop");
      const preview = document.getElementById("preview");

      let files = [];

      function setStatus(msg) {
        console.log("hi");
        statusEl.textContent = msg || "";
      }
      function showError(e) {
        setStatus(e?.message || String(e));
      }

      function addPreview(list) {
        preview.innerHTML = "";
        [...list].forEach((f) => {
          const url = URL.createObjectURL(f);
          const img = new Image();
          img.src = url;
          preview.appendChild(img);
        });
      }

      // Buttons trigger pickers directly (mobile-safe)
      selectBtn.addEventListener("click", () => fileInput.click());
      cameraBtn.addEventListener("click", () => cameraInput.click());

      // File picked handlers
      function onPicked(list) {
        files = [...(list || [])].filter((f) => f.type.startsWith("image/"));
        addPreview(files);
        setStatus(
          files.length
            ? `Selected ${files.length} file(s)`
            : "Pick a photo first."
        );
      }
      fileInput.addEventListener("change", (e) => onPicked(e.target.files));
      cameraInput.addEventListener("change", (e) => onPicked(e.target.files));

      // Drag & drop

      ["dragenter", "dragover"].forEach((ev) =>
        drop.addEventListener(ev, (e) => {
          e.preventDefault();
          e.stopPropagation();
          drop.classList.add("drag");
        })
      );
      ["dragleave", "drop"].forEach((ev) =>
        drop.addEventListener(ev, (e) => {
          e.preventDefault();
          e.stopPropagation();
          drop.classList.remove("drag");
        })
      );
      drop.addEventListener("drop", (e) =>
        onPicked(e.dataTransfer.files || [])
      );

      function makeName(originalName) {
        const ext = (originalName.split(".").pop() || "jpg").toLowerCase();
        const stamp = new Date().toISOString().replace(/[:.]/g, "-");
        const rand = Math.random().toString(36).slice(2, 8);
        return `${stamp}_${rand}.${ext}`;
      }

      async function uploadAll() {
        if (!files.length) {
          setStatus("Pick a photo first.");
          return;
        }
        setStatus("Uploading...");

        // Optional album param: ?album=party
        const params = new URLSearchParams(location.search);
        const subfolder = (params.get("album") || "default").replace(
          /[^a-zA-Z0-9_-]/g,
          ""
        );

        let ok = 0,
          fail = 0;
        for (const f of files) {
          try {
            const path = `${makeName(f.name)}`;
            await uploadBytes(ref(storage, path), f, { contentType: f.type });
            ok++;
          } catch (e) {
            console.error(e);
            fail++;
            showError(e);
          }
        }
        setStatus(`Done: ${ok} uploaded${fail ? `, ${fail} failed` : ""}.`);
        files = [];
        preview.innerHTML = "";
      }
      uploadBtn.addEventListener("click", uploadAll);

      // If your rules require auth, sign in anonymously
      (async () => {
        try {
          await signInAnonymously(auth);
        } catch (e) {
          console.warn("Anonymous sign-in failed (maybe not enabled).", e);
        }
      })();
    </script>
  </body>
</html>
